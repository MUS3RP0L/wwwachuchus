<template>
<div class="row">
    <div class="col-md-12">
        <div class="col-lg-12">
            <div class="panel panel-primary"  :class="show_spinner ? 'sk-loading' : ''" >
                <div class="panel-heading">
                    <h3 class="pull-left">Pago de Aportes</h3>
                    <div class="text-right">
                        <button data-animation="flip" class="btn btn-primary" onclick="printJS('print', 'html')"><i class="fa fa-print" ></i> </button>
                      
                    </div>
                </div>

                <div class="panel-body" id ="print">  
                    <div class="sk-folding-cube" v-show="show_spinner">
                        <div class="sk-cube1 sk-cube"></div>
                        <div class="sk-cube2 sk-cube"></div>
                        <div class="sk-cube4 sk-cube"></div>
                        <div class="sk-cube3 sk-cube"></div>
                    </div>
                    <div class="row" >
                        
                        <div class="col-md-6" style="margin-bottom:20px">
                            <label>Tipo de Aporte:</label>
                            <select required v-model="tipo" class="form-control">
                                <option value="1">Item 0</option>
                                <option value="2">Proceso diciplinario</option>
                                <option value="3">Baja medica</option>
                            </select>
                        </div>
                        
                    </div>
                    <table class="table table-striped" data-page-size="15">
                        <thead>
                        <tr>
                            <th class="footable-visible footable-first-column footable-sortable">Mes/AÃ±o<span class="footable-sort-indicator"></span></th>
                            <th data-hide="phone" class="footable-visible footable-sortable">Total Ganado<span class="footable-sort-indicator"></span></th>
                            <th data-hide="phone" class="footable-visible footable-sortable">F.R.P.<span class="footable-sort-indicator"></span></th>
                            <th data-hide="phone" class="footable-visible footable-sortable">CM<span class="footable-sort-indicator"></span></th>
                            <th data-hide="phone" class="footable-visible footable-sortable">Ajuste UFV<span class="footable-sort-indicator"></span></th>
                            <th data-hide="phone,tablet" class="footable-visible footable-sortable">Subtotal Aporte<span class="footable-sort-indicator"></span></th>
                            <th>Opciones</th>                                    
                        </tr>
                        </thead>
                        <tbody>
                            <tr style="" v-for="(con, index) in contributions" :key="index" id="form">
                                <td>                                    
                                    <input type="text"  v-model="con.monthyear" disabled class="form-control" >
                                </td>
                                <td>
                                    <input type="text" v-model = "con.sueldo" @keyup.enter="CalcularAporte(con, index)"  ref="s1" autofocus class="form-control"  name="aportes[]">
                                </td>
                                <td>
                                    <input type="text"  v-model = "con.fr" disabled class="form-control" name="aportes[]">
                                </td>
                                <td>
                                    <input type="text" v-model = "con.cm" disabled class="form-control" name="aportes[]">
                                </td>
                                <td>
                                    <input type="text" v-model = "con.interes" disabled class="form-control" name="aportes[]">
                                </td>
                                <td>
                                    <input type="text"  v-model = "con.subtotal" disabled class="form-control" name="aportes[]">
                                </td>
                                <td>
                                    <button class="btn btn-warning btn-circle" @click="RemoveRow(index)" type="button"><i class="fa fa-times"></i>  </button>
                                </td>
                                
                            </tr>
                            <tr>
                                <td ><label for="total">Total a Pagar por Concepto de Aportes:</label></td>
                                <td ><input type="text" v-model ="total" disabled class="form-control"></td>
                                <td><label>Literal:</label></td>
                                <!-- <td colspan="3"><input type="text" v-model ="literal" disabled class="form-control"></td> -->
                                <td> <button class="btn btn-success btn-circle" onClick="window.location.reload()" type="button"><i class="fa fa-link"></i></button></td>
                            </tr>                            
                        </tbody>
                    </table>
                    <button class="btn btn-primary " type="button" :disabled="!disabledSaved" @click="Guardar()"><i class="fa fa-save"></i>&nbsp;Guardar</button>

                </div>
               
            </div>
        </div>
    </div>
</div> 
</template>
<script>

export default {
  
   props: ['contributions1'],
  data() {   
    return {
      contributions: [],
      total:0,
      tipo:null,
      ufv:0,
      show_spinner:false
      
    };
  },
   
  mounted() {
   this.contributions = this.contributions1;    
  },
  created(){
      
  },
  methods: {
      RemoveRow(index) {         
        this.contributions.splice(index,1);
        this.SumTotal();
      },
      Refresh() {
        this.contributions = this.contributions1;       
      
      },
      CalcularAporte(con, index){
          if(parseFloat(con.sueldo) >0)
          {          
                
            this.show_spinner=true
            axios.post('/get-interest',{con})
            .then(response => {
                
                this.ufv = response.data
                con.fr = con.sueldo * 0.0477;
                con.cm = con.sueldo * 0.0109;
                con.interes = parseFloat(this.ufv);
                con.subtotal =  con.fr + con.cm + con.interes;
            
                this.show_spinner=false;

                this.SumTotal();
            
            })
            .catch(e => {
                
                this.show_spinner=false;
                alert(e)
            
            })

         
          }
          if(index +1 < this.contributions.length)
            this.$refs.s1[index +1].focus();            
          
      },
      
      SumTotal(){
            let total1 = 0;
            this.contributions.forEach(con => {                            
                total1 += parseFloat(con.subtotal) ;                
           });
        this.total = total1;

      },
      Guardar(){
        if(this.tipo == null || this.tipo == '')
        return ;
        //console.log(this.contributions);
        this.contributions =  this.contributions.filter((item)=> {
            return (item.sueldo != 0 && item.fr != 0 && item.cm !=0 && item.subtotal != 0);
        });
        //console.log(this.contributions);         
        if(this.contributions.length > 0)
        {   
            this.$swal({
            title: 'Esta usted seguro de guardar?',
            text: "whatever",
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Confirmar',
             cancelButtonText: 'Cancelar'
            }).then((result) => {
            if (result.value) {
                
                var aportes = this.contributions;
                console.log(aportes);
                
                axios.post('/contribution_save',{aportes,total:this.total,tipo:this.tipo})
                .then(response => {
                console.log(response.data);                
                })
                .catch(e => {
                this.show_spinner = false;
                alert(e);
                })

                this.$swal({
                title: 'Pago realizado',
                showConfirmButton: false,
                timer: 1500,
                type: 'success'
                })
            }
            })

            
        }
        else
        {
                        
                        
           
            //alert("No existen registros");
        }
        
        
    
    },


    

  },
  computed: {
      disabledSaved(){
       return this.contributions.some((c)=> c.subtotal > 0 );
      }
  }

 
}
</script>

